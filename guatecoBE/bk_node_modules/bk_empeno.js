const express = require('express');
const operations = require('../operations');
const multer = require('multer');
const path = require('path');
const router = express.Router()
module.exports = router

const storage = multer.memoryStorage();
const upload = multer({ storage: storage });

router.post('/', upload.array('photos', 4), async (req, res) => {
    var user = req.session.user;
    if (user) {
        var op = parseInt(req.body.op);
        var data = req.body
        switch (op) {
            case 1:
                res.setHeader('Content-Type', 'application/json');
                values = [];
                const tipos_articulos = await new Promise((resolve, reject) => {
                    sql = "SELECT * FROM tipoArticulo";
                    operations.executeQuery(sql, values, (result) =>{ 
                        resolve(result);
                    });
                });
            
                const tipos_cuotas = await new Promise((resolve, reject) => {
                    sql = "SELECT * FROM cuota";
                    operations.executeQuery(sql, values, (result) =>{ 
                        resolve(result);
                    });
                });
            
                res.send({ta:tipos_articulos, tc:tipos_cuotas});
            break;
            case 2:
                res.setHeader('Content-Type', 'text/plain');
                const new_articulo = await new Promise((resolve, reject) => {
                    var values = [data.precio, data.cantidad_cuotas, data.cuota, data.ponderacion, data.tipo_art, 10];
                    try {
                        //INGRESAMOS EL ARTICULO
                        sql = "INSERT INTO articulo (valor, cuotas, fkCuota, ponderacion, fkTipoArticulo, fkEstadoArticulo) VALUES(?,?,?,?,?,?)";
                        operations.executeQuery(sql, values, (result) =>{ 
    
                            //PASAMOS LA IMAGENES A BASE64
                            const imagenes = req.files.map(file => ({
                                data: `data:image/${path.extname(file.originalname).toLowerCase().substring(1)};base64,`+ file.buffer.toString('base64')
                            }));
                            
                            //AGREGAMOS LAS FOTOS A LA BASE DE DATOS
                            for (let index = 0; index < imagenes.length; index++) {
                                const element = imagenes[index];
                                var values = [element.data, result.insertId, 1];
                                sql = "INSERT INTO imagen (imagen, idArticulo, estado)  VALUES(?,?,?);";
                                operations.executeQuery(sql, values, (result) =>{});
                            }
                            resolve(result.insertId);
                        });
                    } catch (error) {
                        reject(0);
                    }
                });

                //SI SE CREA EL NUEVO ARTICULO SE CREA EL EMPEÃ‘O. 
                if (new_articulo > 0) {
                    const new_empeno = await new Promise((resolve, reject) => {
                        res.setHeader('Content-Type', 'application/json');
                        var values = [data.titulo, data.descripcion, 1, new_articulo, data.cuota, user.id];
                        sql = "INSERT INTO empeno (titulo, descripcion, fkestadoEmpeno, fkArticulo, fkcuota, fkUsuario, fechaIngreso) VALUES (?,?,?,?,?,?,NOW());";
                        operations.executeQuery(sql, values, (result) =>{ 
                            if (result.insertId > 0) {
                                resolve(true);
                            }else{
                                resolve(false);
                            }
                        });
                    });
                }

                
                //DEVOLVEMOS UN MENSAJE DE RESPUESTA.
                res.status(200).json({ mensaje: true });
            break;
        }
    }
});